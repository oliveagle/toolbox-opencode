name: Check and Update Versions

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
  repository_dispatch:
    types: [upstream_release]

permissions:
  contents: write
  actions: read

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      opencode_updated: ${{ steps.check-opencode.outputs.updated }}
      claude_code_updated: ${{ steps.check-claude-code.outputs.updated }}
      opencode_version: ${{ steps.check-opencode.outputs.new_version }}
      claude_code_version: ${{ steps.check-claude-code.outputs.new_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current versions
        id: current-versions
        run: |
          if [ -f VERSION ]; then
            echo "Current VERSION file content:"
            cat VERSION
          else
            echo "VERSION file not found"
          fi

      - name: Check OpenCode release
        id: check-opencode
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OPENCODE_LATEST=$(gh api repos/anomalyco/opencode/releases/latest --jq '.tag_name' 2>/dev/null | sed 's/v//' || echo "unknown")
          echo "OpenCode latest version: $OPENCODE_LATEST"

          CURRENT=$(grep "opencode=" VERSION 2>/dev/null | cut -d'=' -f2 || echo "0.0.0")
          echo "OpenCode current version: $CURRENT"

          if [ "$OPENCODE_LATEST" != "$CURRENT" ] && [ "$OPENCODE_LATEST" != "unknown" ]; then
            echo "OpenCode update available: $CURRENT -> $OPENCODE_LATEST"
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "new_version=$OPENCODE_LATEST" >> $GITHUB_OUTPUT
          else
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "new_version=$CURRENT" >> $GITHUB_OUTPUT
          fi

      - name: Check Claude Code release
        id: check-claude-code
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CLAUDE_CODE_LATEST=$(gh api repos/anthropics/claude-code/releases/latest --jq '.tag_name' 2>/dev/null | sed 's/v//' || echo "unknown")
          echo "Claude Code latest version: $CLAUDE_CODE_LATEST"

          CURRENT=$(grep "claude_code=" VERSION 2>/dev/null | cut -d'=' -f2 || echo "0.0.0")
          echo "Claude Code current version: $CURRENT"

          if [ "$CLAUDE_CODE_LATEST" != "$CURRENT" ] && [ "$CLAUDE_CODE_LATEST" != "unknown" ]; then
            echo "Claude Code update available: $CURRENT -> $CLAUDE_CODE_LATEST"
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "new_version=$CLAUDE_CODE_LATEST" >> $GITHUB_OUTPUT
          else
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "new_version=$CURRENT" >> $GITHUB_OUTPUT
          fi

  update-versions:
    needs: check-versions
    runs-on: ubuntu-latest
    if: ${{ needs.check-versions.outputs.opencode_updated == 'true' || needs.check-versions.outputs.claude_code_updated == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Read current versions
        id: current-versions
        run: |
          OPENCODE_CURRENT=$(grep "opencode=" VERSION 2>/dev/null | cut -d'=' -f2 || echo "0.0.0")
          CLAUDE_CODE_CURRENT=$(grep "claude_code=" VERSION 2>/dev/null | cut -d'=' -f2 || echo "0.0.0")
          echo "OpenCode current: $OPENCODE_CURRENT, Claude Code current: $CLAUDE_CODE_CURRENT"
          echo "opencode_current=$OPENCODE_CURRENT" >> $GITHUB_OUTPUT
          echo "claude_code_current=$CLAUDE_CODE_CURRENT" >> $GITHUB_OUTPUT

      - name: Determine new versions
        id: new-versions
        env:
          OPENCODE_UPDATED: ${{ needs.check-versions.outputs.opencode_updated }}
          OPENCODE_NEW: ${{ needs.check-versions.outputs.opencode_version }}
          OPENCODE_CURRENT: ${{ steps.current-versions.outputs.opencode_current }}
          CLAUDE_CODE_UPDATED: ${{ needs.check-versions.outputs.claude_code_updated }}
          CLAUDE_CODE_NEW: ${{ needs.check-versions.outputs.claude_code_version }}
          CLAUDE_CODE_CURRENT: ${{ steps.current-versions.outputs.claude_code_current }}
        run: |
          if [ "$OPENCODE_UPDATED" == "true" ]; then
            OPENCODE_FINAL=$OPENCODE_NEW
          else
            OPENCODE_FINAL=$OPENCODE_CURRENT
          fi

          if [ "$CLAUDE_CODE_UPDATED" == "true" ]; then
            CLAUDE_CODE_FINAL=$CLAUDE_CODE_NEW
          else
            CLAUDE_CODE_FINAL=$CLAUDE_CODE_CURRENT
          fi

          echo "OpenCode final: $OPENCODE_FINAL, Claude Code final: $CLAUDE_CODE_FINAL"

          cat > VERSION << EOF
          opencode=$OPENCODE_FINAL
          claude_code=$CLAUDE_CODE_FINAL
          EOF

          echo "Updated VERSION file:"
          cat VERSION
          echo "commit_message=Update versions: opencode=$OPENCODE_FINAL, claude_code=$CLAUDE_CODE_FINAL" >> $GITHUB_ENV

      - name: Update VERSION_HISTORY.md
        run: |
          echo "" >> VERSION_HISTORY.md
          echo "## $(date -u '+%Y-%m-%d')" >> VERSION_HISTORY.md
          cat VERSION >> VERSION_HISTORY.md

      - name: Commit and push
        run: |
          git add VERSION VERSION_HISTORY.md
          if ! git diff --cached --quiet; then
            git commit -m "${{ env.commit_message }}"
            git push origin main
            echo "Version update committed and pushed"
          else
            echo "No changes to commit"
          fi

#!/bin/bash
#
# AI Agent Toolbox - 多 Agent 容器管理工具
# 支持: opencode, claude, kilo, copilot, qwen, codebuddy, occ
#

set -euo pipefail

# 基础配置
AGENTBOX_BASE_IMAGE="${AGENTBOX_BASE_IMAGE:-ghcr.io/oliveagle/agentbox/agentbox-base:latest}"
CONTAINER_ENGINE="${CONTAINER_ENGINE:-podman}"
INSTALL_DIR="${INSTALL_DIR:-${HOME}/.local/share/agentbox}"
CONFIG_DIR="${HOME}/.config/agentbox"

# 颜色
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }
log_agent() { echo -e "${CYAN}[$1]${NC} $2"; }

# 获取用户信息
get_user_info() {
    export HOST_USER="${USER:-$(id -un)}"
    export HOST_UID="${HOST_UID:-$(id -u)}"
    export HOST_GID="${HOST_GID:-$(id -g)}"
    export HOST_HOME="${HOME:-$(getent passwd "$HOST_USER" | cut -d: -f6)}"
}

# 检测容器引擎
detect_engine() {
    if command -v podman &> /dev/null; then
        echo "podman"
    elif command -v docker &> /dev/null; then
        echo "docker"
    else
        echo "podman"
    fi
}

# 生成有效的名称
normalize_name() {
    local input="${1:-}"
    
    if [[ -z "$input" ]]; then
        input=$(basename "$(pwd)")
    fi
    
    if [[ "$input" == "." ]]; then
        input=$(basename "$(pwd)")
    elif [[ "$input" == ".." ]]; then
        input=$(basename "$(cd .. && pwd)")
    fi
    
    if [[ "$input" == */* ]]; then
        input=$(basename "$input")
    fi
    
    input=$(echo "$input" | tr -cd '[:alnum:]_-')
    input=$(echo "$input" | tr '[:upper:]' '[:lower:]')
    
    [[ -z "$input" ]] && input="default"
    
    echo "$input"
}

# Generate container name
generate_container_name() {
    local agent="$1"
    local project="$2"
    echo "agentbox-${agent}-${project}"
}

# 生成镜像名称
generate_image_name() {
    local agent="$1"
    echo "localhost/agentbox-${agent}:latest"
}

# 获取脚本所在目录
get_script_dir() {
    cd "$(dirname "${BASH_SOURCE[0]}")" && pwd
}

# 初始化配置
init_config() {
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
    fi
    
    if [[ ! -f "$CONFIG_DIR/agents.yaml" ]]; then
        cat > "$CONFIG_DIR/agents.yaml" << 'EOF'
# AI Agent Toolbox 配置

# 默认 Agent
default_agent: opencode

# Agent 定义
agents:
  opencode:
    name: OpenCode
    description: OpenCode AI coding agent
    image: localhost/agentbox-opencode:latest
    cmd: opencode
    config_dir: ~/.config/opencode
    
  claude-code:
    name: Claude Code
    description: Anthropic Claude Code
    image: localhost/agentbox-claude-code:latest
    cmd: claude
    config_dir: ~/.config/claude
    
  kilo:
    name: Kilo
    description: Kilo AI coding agent
    image: localhost/agentbox-kilo:latest
    cmd: kilo
    config_dir: ~/.config/kilo
    
  copilot:
    name: GitHub Copilot
    description: GitHub Copilot CLI
    image: localhost/agentbox-copilot:latest
    cmd: "gh copilot"
    config_dir: ~/.config/gh
    
  qwen:
    name: Qwen
    description: Qwen AI coding agent
    image: localhost/agentbox-qwen:latest
    cmd: qwen
    config_dir: ~/.config/qwen
    
  codebuddy:
    name: CodeBuddy
    description: CodeBuddy AI agent
    image: localhost/agentbox-codebuddy:latest
    cmd: codebuddy
    config_dir: ~/.config/codebuddy

  occ:
    name: OCC
    description: OpenCode + Claude Code combined
    image: localhost/agentbox-occ:latest
    cmd: claude
    config_dir: ~/.config/claude

# 默认挂载设置
mounts:
  # 项目代码（必须）
  project: true
  
  # Agent 配置（必须）
  agent_config: true
  
  # Git 配置
  gitconfig: true
  
  # SSH keys
  ssh: false
  
  # Docker/Podman socket
  docker: false
  
  # 显示服务器
  display: true
  
  # 共享缓存目录
  shared_cache: true

# 全局环境变量
env:
  EDITOR: vim
  TZ: Asia/Shanghai
EOF
    fi

    # Generate SSH key pair for agentbox if not exists
    setup_agentbox_ssh_keys
}

# Setup SSH keys for agentbox
setup_agentbox_ssh_keys() {
    local ssh_dir="${CONFIG_DIR}/ssh"
    local private_key="${ssh_dir}/id_ed25519"
    local public_key="${ssh_dir}/id_ed25519.pub"

    if [[ ! -f "$private_key" ]]; then
        mkdir -p "$ssh_dir"
        chmod 700 "$ssh_dir"
        ssh-keygen -t ed25519 -f "$private_key" -N "" -C "agentbox@$(hostname)"
        chmod 600 "$private_key"
        chmod 644 "$public_key"
        log_success "SSH key generated: ${CONFIG_DIR}/ssh/"
        log_info "Public key:"
        cat "$public_key"
        echo
        log_info "Add the above public key to your GitHub/GitLab SSH keys"
    fi
}

# Get agentbox SSH directory
get_agentbox_ssh_dir() {
    echo "${CONFIG_DIR}/ssh"
}

# Parse agent config
get_agent_config() {
    local agent="$1"
    local key="$2"
    local config_file="$CONFIG_DIR/agents.yaml"
    
    if [[ -f "$config_file" ]]; then
        grep -A 20 "^  ${agent}:" "$config_file" 2>/dev/null | \
        grep "^    ${key}:" | head -1 | sed "s/^    ${key}:\s*//" | tr -d '"' || echo ""
    else
        echo ""
    fi
}

# Parse agent config for list of values (for multiple config_dirs)
get_agent_config_list() {
    local agent="$1"
    local key="$2"
    local config_file="$CONFIG_DIR/agents.yaml"
    
    if [[ -f "$config_file" ]]; then
        grep -A 20 "^  ${agent}:" "$config_file" 2>/dev/null | \
        grep "^    ${key}:" | sed "s/^    ${key}:\s*//" | tr -d '"' | tr -d ' '
    else
        echo ""
    fi
}

# 获取全局配置
get_global_config() {
    local key="$1"
    local config_file="$CONFIG_DIR/agents.yaml"
    
    if [[ -f "$config_file" ]]; then
        grep "^  ${key}:" "$config_file" 2>/dev/null | head -1 | sed "s/^  ${key}:\s*//" | tr -d '"' || echo ""
    else
        echo ""
    fi
}

# 构建基础镜像
build_base_image() {
    log_info "构建基础镜像 agentbox-base..."

    local script_dir
    script_dir=$(get_script_dir)

    if [[ ! -f "$script_dir/images/Containerfile.base" ]]; then
        log_error "未找到基础镜像 Containerfile"
        return 1
    fi

    # Build args for proxy (from environment variables)
    local build_args=()
    [[ -n "${HTTP_PROXY:-}" ]] && build_args+=(--build-arg "HTTP_PROXY=$HTTP_PROXY")
    [[ -n "${HTTPS_PROXY:-}" ]] && build_args+=(--build-arg "HTTPS_PROXY=$HTTPS_PROXY")
    [[ -n "${NO_PROXY:-}" ]] && build_args+=(--build-arg "NO_PROXY=$NO_PROXY")
    [[ -n "${http_proxy:-}" ]] && build_args+=(--build-arg "http_proxy=$http_proxy")
    [[ -n "${https_proxy:-}" ]] && build_args+=(--build-arg "https_proxy=$https_proxy")
    [[ -n "${no_proxy:-}" ]] && build_args+=(--build-arg "no_proxy=$no_proxy")

    # Use host network for build (needed for localhost proxy access)
    build_args+=(--network=host)

    cd "$script_dir/images"
    "$CONTAINER_ENGINE" build "${build_args[@]}" -t "$TOOLBOX_BASE_IMAGE" -f Containerfile.base . && \
        log_success "基础镜像构建成功: $TOOLBOX_BASE_IMAGE" || \
        log_error "基础镜像构建失败"
}

# 构建 Agent 镜像
build_agent_image() {
    local agent="${1:-}"

    if [[ -z "$agent" ]]; then
        log_error "需要指定 Agent 名称"
        echo "Available agents: occ"
        return 1
    fi

    local script_dir
    script_dir=$(get_script_dir)

    local agent_dir="$script_dir/agents/$agent"
    local agent_file="$agent_dir/Containerfile"

    if [[ ! -f "$agent_file" ]]; then
        log_error "未找到 Agent '$agent' 的 Containerfile"
        log_info "可用 agents:"
        ls -1 "$script_dir/agents/" 2>/dev/null | while read -r a; do
            [[ -d "$script_dir/agents/$a" ]] && echo "  - $a"
        done
        return 1
    fi

    # 先确保基础镜像存在，尝试从 ghcr.io 拉取
    if ! "$CONTAINER_ENGINE" image exists "$TOOLBOX_BASE_IMAGE" 2>/dev/null && \
       ! "$CONTAINER_ENGINE" images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${TOOLBOX_BASE_IMAGE}$"; then
        log_info "基础镜像不存在，尝试从 registry 拉取..."
        if ! "$CONTAINER_ENGINE" pull "$TOOLBOX_BASE_IMAGE" 2>/dev/null; then
            log_warn "拉取失败，尝试本地构建基础镜像..."
            build_base_image || return 1
        fi
    fi

    # Build args for proxy (from environment variables)
    local build_args=()
    [[ -n "${HTTP_PROXY:-}" ]] && build_args+=(--build-arg "HTTP_PROXY=$HTTP_PROXY")
    [[ -n "${HTTPS_PROXY:-}" ]] && build_args+=(--build-arg "HTTPS_PROXY=$HTTPS_PROXY")
    [[ -n "${NO_PROXY:-}" ]] && build_args+=(--build-arg "NO_PROXY=$NO_PROXY")
    [[ -n "${http_proxy:-}" ]] && build_args+=(--build-arg "http_proxy=$http_proxy")
    [[ -n "${https_proxy:-}" ]] && build_args+=(--build-arg "https_proxy=$https_proxy")
    [[ -n "${no_proxy:-}" ]] && build_args+=(--build-arg "no_proxy=$no_proxy")

    # Use host network for build (needed for localhost proxy access)
    build_args+=(--network=host)

    local image_name
    image_name=$(generate_image_name "$agent")

    log_info "构建 Agent 镜像: $agent -> $image_name"

    cd "$agent_dir"
    "$CONTAINER_ENGINE" build "${build_args[@]}" -t "$image_name" -f Containerfile . && \
        log_success "Agent 镜像构建成功: $image_name" || \
        log_error "Agent 镜像构建失败"
}

# 构建所有 Agent 镜像
build_all_agents() {
    local script_dir
    script_dir=$(get_script_dir)
    
    log_info "构建所有 Agent 镜像..."
    
    # 先构建基础镜像
    build_base_image || return 1
    
    # 遍历所有 agent 目录
    for agent_dir in "$script_dir"/agents/*/; do
        if [[ -d "$agent_dir" ]]; then
            local agent=$(basename "$agent_dir")
            log_info "构建 agent: $agent"
            build_agent_image "$agent" || log_warn "$agent 构建失败"
        fi
    done
    
    log_success "所有 Agent 镜像构建完成"
}

# 列出所有可用 agents
list_agents() {
    local script_dir
    script_dir=$(get_script_dir)
    
    log_info "可用 AI Agents:"
    echo
    
    printf "%-15s %-20s %s\n" "Agent" "名称" "镜像"
    echo "$(printf '%0.s-' {1..70})"
    
    for agent_dir in "$script_dir"/agents/*/; do
        if [[ -d "$agent_dir" ]]; then
            local agent=$(basename "$agent_dir")
            local name=$(get_agent_config "$agent" "name")
            local image=$(generate_image_name "$agent")
            
            # 检查镜像是否存在
            local status=""
            if "$CONTAINER_ENGINE" image exists "$image" 2>/dev/null || \
               "$CONTAINER_ENGINE" images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${image}$"; then
                status="${GREEN}已安装${NC}"
            else
                status="${YELLOW}未安装${NC}"
            fi
            
            printf "%-15s %-20s %s %b\n" "$agent" "${name:-$agent}" "$image" "$status"
        fi
    done
    echo
}

# 生成挂载参数
generate_mount_args() {
    local agent="$1"
    local project_path="${2:-}"
    local mount_args=()
    
    get_user_info
    
    # 基础挂载
    mount_args+=(--volume /etc/localtime:/etc/localtime:ro)
    mount_args+=(--volume /tmp:/tmp)
    
    # 共享缓存
    local cache_dir="${HOST_HOME}/.cache/agentbox"
    mkdir -p "$cache_dir"
    mount_args+=(--volume "${cache_dir}:/tmp/agent-cache")
    
    # Agent 配置（必须挂载）- 支持多个配置目录
    # 挂载到容器内的正确位置
    local mount_agent_config
    mount_agent_config=$(get_global_config "agent_config")
    if [[ "${mount_agent_config:-true}" == "true" ]]; then
        # 首先检查 config_dirs（逗号分隔），回退到 config_dir
        local agent_config_dirs_raw
        agent_config_dirs_raw=$(get_agent_config "$agent" "config_dirs")
        if [[ -z "$agent_config_dirs_raw" ]]; then
            agent_config_dirs_raw=$(get_agent_config "$agent" "config_dir")
        fi

        if [[ -n "$agent_config_dirs_raw" ]]; then
            # 支持逗号分隔的多个目录
            IFS=',' read -ra dirs <<< "$agent_config_dirs_raw"
            for agent_config_dir in "${dirs[@]}"; do
                # 去除空格
                agent_config_dir=$(echo "$agent_config_dir" | xargs)
                [[ -z "$agent_config_dir" ]] && continue

                # 如果路径以 ~ 开头，展开为 $HOST_HOME
                if [[ "$agent_config_dir" == "~"* ]]; then
                    agent_config_dir="$HOST_HOME${agent_config_dir:1}"
                fi

                if [[ -d "$agent_config_dir" ]]; then
                    # 挂载到容器内的对应位置（保持原路径结构）
                    mount_args+=(--volume "${agent_config_dir}:${agent_config_dir}:rw")
                fi
            done
        fi
    fi
    
    # Git 配置
    local mount_git
    mount_git=$(get_global_config "gitconfig")
    if [[ "${mount_git:-true}" == "true" ]]; then
        [[ -f "${HOST_HOME}/.gitconfig" ]] && mount_args+=(--volume "${HOST_HOME}/.gitconfig:${HOST_HOME}/.gitconfig:ro")
        [[ -f "${HOST_HOME}/.git-credentials" ]] && mount_args+=(--volume "${HOST_HOME}/.git-credentials:${HOST_HOME}/.git-credentials:ro")
    fi
    
    # SSH keys
    local mount_ssh
    mount_ssh=$(get_global_config "ssh")
    if [[ "${mount_ssh:-false}" == "true" ]]; then
        # Mount agentbox SSH keys (from config directory)
        local agentbox_ssh_dir
        agentbox_ssh_dir=$(get_agentbox_ssh_dir)
        if [[ -d "$agentbox_ssh_dir" ]]; then
            mount_args+=(--volume "${agentbox_ssh_dir}:${HOST_HOME}/.ssh/agentbox:ro")
        fi
        # Also mount host SSH if exists
        if [[ -d "${HOST_HOME}/.ssh" ]]; then
            mount_args+=(--volume "${HOST_HOME}/.ssh:${HOST_HOME}/.ssh:ro")
            [[ -S "${SSH_AUTH_SOCK:-}" ]] && mount_args+=(--volume "${SSH_AUTH_SOCK}:${SSH_AUTH_SOCK}:ro")
        fi
    fi
    
    # Docker/Podman
    local mount_docker
    mount_docker=$(get_global_config "docker")
    if [[ "${mount_docker:-false}" == "true" ]]; then
        [[ -S /var/run/docker.sock ]] && mount_args+=(--volume /var/run/docker.sock:/var/run/docker.sock:rw)
        [[ -S /run/podman/podman.sock ]] && mount_args+=(--volume /run/podman/podman.sock:/run/podman/podman.sock:rw)
    fi
    
    # 显示
    local mount_display
    mount_display=$(get_global_config "display")
    if [[ "${mount_display:-true}" == "true" ]]; then
        [[ -d /tmp/.X11-unix ]] && mount_args+=(--volume /tmp/.X11-unix:/tmp/.X11-unix:ro)
        mount_args+=(--env "DISPLAY=${DISPLAY:-:0}")
    fi
    
    # 项目目录
    if [[ -n "$project_path" && -d "$project_path" ]]; then
        local abs_path
        abs_path=$(cd "$project_path" && pwd)
        mount_args+=(--volume "${abs_path}:${abs_path}:rw")
        mount_args+=(--workdir "$abs_path")
    fi
    
    printf '%s\n' "${mount_args[@]}"
}

# 创建 agentbox
create_agentbox() {
    local agent="${1:-}"
    local project_name="${2:-}"
    
    # 如果没有指定 agent，使用默认
    if [[ -z "$agent" ]]; then
        agent=$(get_global_config "default_agent")
        agent="${agent:-opencode}"
    fi
    
    # 规范化项目名
    project_name=$(normalize_name "${project_name:-$(pwd)}")
    
    local container_name
    container_name=$(generate_container_name "$agent" "$project_name")
    
    local image_name
    image_name=$(generate_image_name "$agent")
    
    log_agent "$agent" "创建 agentbox: $container_name"
    
    # 检查容器是否已存在
    if "$CONTAINER_ENGINE" ps -a --format '{{.Names}}' | grep -q "^${container_name}$"; then
        log_warn "容器 '$container_name' 已存在"
        read -p "删除并重新创建? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            "$CONTAINER_ENGINE" rm -f "$container_name" 2>/dev/null || true
        else
            log_info "使用现有容器"
            return 0
        fi
    fi
    
    get_user_info
    
    # 确保镜像存在
    if ! "$CONTAINER_ENGINE" image exists "$image_name" 2>/dev/null && \
       ! "$CONTAINER_ENGINE" images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${image_name}$"; then
        log_info "镜像不存在，先构建..."
        build_agent_image "$agent" || return 1
    fi
    
    # 准备挂载参数
    local mount_args
    mount_args=$(generate_mount_args "$agent" "$(pwd)")
    
    # 准备 agentbox home
    local agentbox_home="${HOST_HOME}/.local/share/agentbox/${agent}/${project_name}"
    mkdir -p "$agentbox_home"
    
    # 引擎参数
    local engine_args=()
    if [[ "$CONTAINER_ENGINE" == "podman" ]]; then
        engine_args+=(--userns=keep-id --hostname="${agent}-${project_name}")
    else
        engine_args+=(--hostname="${agent}-${project_name}")
    fi
    
    # 运行参数
    local run_args=(
        --name "$container_name"
        --detach
        --interactive
        --tty
        --env "USER=${HOST_USER}"
        --env "HOST_USER=${HOST_USER}"
        --env "HOST_UID=${HOST_UID}"
        --env "HOST_GID=${HOST_GID}"
        --env "HOME=${agentbox_home}"
        --env "AGENTBOX_HOME=${agentbox_home}"
        --env "AGENT=${agent}"
        --volume "${agentbox_home}:${agentbox_home}:rw"
        --env "EDITOR=vim"
        --env "TZ=Asia/Shanghai"
        --network bridge
    )

    # 添加挂载
    while IFS= read -r line; do
        [[ -n "$line" ]] && run_args+=("$line")
    done <<< "$mount_args"

    # 添加 Claude/OpenCode 配置环境变量
    local claude_settings="${HOST_HOME}/.claude/settings.json"
    if [[ -f "$claude_settings" ]]; then
        # 读取 settings.json 中的 env 部分并添加到容器
        local env_vars
        env_vars=$(jq -r '.env | to_entries[] | "--env \(.key)=\(.value)"' "$claude_settings" 2>/dev/null || true)
        if [[ -n "$env_vars" ]]; then
            while IFS= read -r env_var; do
                [[ -n "$env_var" ]] && run_args+=($env_var)
            done <<< "$env_vars"
        fi
    fi

    # 创建容器（使用镜像的 entrypoint 来处理权限）
    "$CONTAINER_ENGINE" run "${engine_args[@]}" "${run_args[@]}" "$image_name"

    # 等待 entrypoint 完成初始化
    sleep 1

    # 修复 /home/agentboxuser 目录的所有权（可能由 root 创建）
    # 使用 root 在容器内执行 chown
    "$CONTAINER_ENGINE" exec --user root "$container_name" bash -c "
        if [[ -d /home/agentboxuser ]]; then
            chown -R ${HOST_UID}:${HOST_GID} /home/agentboxuser
            echo '[agentbox] Fixed /home/agentboxuser ownership'
        fi
    " 2>/dev/null || true

    # 创建配置目录符号链接（让 agent 能找到配置）
    create_config_symlinks "$container_name" "$agent" "$agentbox_home"
    
    log_success "Agentbox 创建成功: $container_name"
    log_info "进入: agentbox enter $agent $project_name"
}

# 创建配置目录符号链接
create_config_symlinks() {
    local container_name="$1"
    local agent="$2"
    local agentbox_home="$3"

    get_user_info

    # OCC agent 需要同时链接 opencode 和 claude 配置
    local config_dirs=()
    if [[ "$agent" == "occ" ]]; then
        config_dirs=("opencode" "claude")
    else
        # 从配置中获取 config_dir
        local config_dirs_raw
        config_dirs_raw=$(get_agent_config_list "$agent" "config_dir")
        while IFS= read -r dir; do
            [[ -n "$dir" ]] && config_dirs+=$(basename "$dir")
        done <<< "$config_dirs_raw"
    fi

    for config_name in "${config_dirs[@]}"; do
        [[ -z "$config_name" ]] && continue
        local src_path="${HOST_HOME}/.config/${config_name}"
        if [[ -d "$src_path" ]]; then
            "$CONTAINER_ENGINE" exec "$container_name" bash -c "
                mkdir -p ${agentbox_home}/.config
                if [[ ! -e \"${agentbox_home}/.config/${config_name}\" && ! -L \"${agentbox_home}/.config/${config_name}\" ]]; then
                    ln -s \"${src_path}\" \"${agentbox_home}/.config/${config_name}\"
                    echo 'Linked ${agentbox_home}/.config/${config_name} -> ${src_path}'
                fi
            " 2>/dev/null || true
        fi
    done
}

# 设置容器用户
setup_container_user() {
    local container_name="$1"
    local agentbox_home="$2"
    
    get_user_info
    
    "$CONTAINER_ENGINE" exec "$container_name" sh -c "
        getent group ${HOST_GID} >/dev/null 2>&1 || groupadd -g ${HOST_GID} ${HOST_USER}
        id -u ${HOST_USER} >/dev/null 2>&1 || useradd -m -u ${HOST_UID} -g ${HOST_GID} -s /bin/bash ${HOST_USER}
        usermod -aG sudo ${HOST_USER} 2>/dev/null || true
        echo '%sudo ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/agentbox
        chmod 440 /etc/sudoers.d/agentbox
        mkdir -p ${agentbox_home}
        chown -R ${HOST_UID}:${HOST_GID} ${agentbox_home}
    " 2>/dev/null || true
}

# 进入 agentbox
enter_agentbox() {
    local agent="${1:-}"
    local project_name="${2:-}"
    
    # 如果没有指定，使用默认
    if [[ -z "$agent" ]]; then
        agent=$(get_global_config "default_agent")
        agent="${agent:-opencode}"
    fi
    
    project_name=$(normalize_name "${project_name:-$(pwd)}")
    
    local container_name
    container_name=$(generate_container_name "$agent" "$project_name")
    
    # 检查容器是否存在
    if ! "$CONTAINER_ENGINE" ps -a --format '{{.Names}}' | grep -q "^${container_name}$"; then
        log_warn "容器 '$container_name' 不存在"
        read -p "现在创建? [Y/n] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            create_agentbox "$agent" "$project_name"
        else
            exit 1
        fi
    fi
    
    # 启动容器
    if ! "$CONTAINER_ENGINE" ps --format '{{.Names}}' | grep -q "^${container_name}$"; then
        log_info "启动容器..."
        "$CONTAINER_ENGINE" start "$container_name" > /dev/null
    fi
    
    get_user_info
    
    local agentbox_home="${HOST_HOME}/.local/share/agentbox/${agent}/${project_name}"
    local agent_name
    agent_name=$(get_agent_config "$agent" "name")
    
    log_agent "$agent" "进入 agentbox: $container_name"
    echo -e "${GREEN}⬢${NC} ${CYAN}${agent_name:-$agent}${NC} 模式"
    echo
    
    exec "$CONTAINER_ENGINE" exec -it \
        --user "$HOST_UID:$HOST_GID" \
        --env "HOME=$agentbox_home" \
        --env "AGENTBOX_HOME=$agentbox_home" \
        "$container_name" \
        /bin/bash -c "
            export PATH=\"${agentbox_home}/.local/bin:/usr/local/bin:/usr/bin:/bin\"
            export PS1='\\[\\033[0;32m\\]⬢[\\033[0m\\] \\[\\033[1;36m\\]${agent}\\[\\033[0m\\]:\\[\\033[0;34m\\]\\w\\[\\033[0m\\]\\$ '
            cd '$(pwd)' 2>/dev/null || cd '$agentbox_home'
            
            echo -e '${GREEN}AI Agent Toolbox Ready!${NC}'
            echo -e '${BLUE}Agent: ${agent}${NC}'
            echo -e '${BLUE}隔离 home: ${agentbox_home}${NC}'
            echo ''
            
            exec /bin/bash --rcfile <(echo '
                export PATH=\"${agentbox_home}/.local/bin:/usr/local/bin:/usr/bin:/bin\"
                export PS1=\"\\[\\033[0;32m\\]⬢[\\033[0m\\] \\[\\033[1;36m\\]${agent}\\[\\033[0m\\]:\\[\\033[0;34m\\]\\w\\[\\033[0m\\]\\$ \"
                alias ll=\"ls -la\"
            ')
        "
}

# 运行命令
run_agentbox() {
    local agent="${1:-}"
    shift || true
    
    if [[ -z "$agent" || "$agent" == --* ]]; then
        log_error "需要指定 Agent 名称"
        echo "用法: agentbox run <agent> [命令]"
        return 1
    fi
    
    # 剩余参数中找项目名和命令
    local project_name=""
    local cmd_args=()
    
    for arg in "$@"; do
        if [[ -z "$project_name" && ! "$arg" == --* && ! "$arg" == -* ]]; then
            project_name="$arg"
        else
            cmd_args+=("$arg")
        fi
    done
    
    project_name=$(normalize_name "${project_name:-$(pwd)}")
    
    local container_name
    container_name=$(generate_container_name "$agent" "$project_name")
    
    # 确保容器运行
    if ! "$CONTAINER_ENGINE" ps --format '{{.Names}}' | grep -q "^${container_name}$"; then
        if "$CONTAINER_ENGINE" ps -a --format '{{.Names}}' | grep -q "^${container_name}$"; then
            "$CONTAINER_ENGINE" start "$container_name" > /dev/null
        else
            log_error "容器不存在，先创建: agentbox create $agent $project_name"
            return 1
        fi
    fi
    
    get_user_info
    
    local agentbox_home="${HOST_HOME}/.local/share/agentbox/${agent}/${project_name}"
    
    # 如果没有命令，使用 agent 默认命令
    if [[ ${#cmd_args[@]} -eq 0 ]]; then
        local agent_cmd
        agent_cmd=$(get_agent_config "$agent" "cmd")
        cmd_args=("${agent_cmd:-$agent}")
    fi
    
    log_agent "$agent" "运行: ${cmd_args[*]}"
    
    "$CONTAINER_ENGINE" exec \
        --user "$HOST_UID:$HOST_GID" \
        --env "HOME=$agentbox_home" \
        --env "PATH=${agentbox_home}/.local/bin:/usr/local/bin:/usr/bin:/bin" \
        "$container_name" \
        /bin/bash -c "cd '\$(pwd)' 2>/dev/null || true; exec ${cmd_args[*]}"
}

# 列出所有 agentbox
list_agentboxes() {
    get_user_info
    log_info "AI Agent Toolbox 容器:"
    echo

    local containers
    containers=$("$CONTAINER_ENGINE" ps -a --filter "name=agentbox-" --format "{{.Names}}|{{.Status}}" 2>/dev/null)

    if [[ -n "$containers" ]]; then
        printf "%-30s %-10s %-35s %-15s\n" "项目名" "Agent" "容器名" "状态"
        echo "$(printf '%0.s-' {1..100})"

        while IFS='|' read -r name status; do
            # 解析 agent 和 project 名称
            # 容器名格式: agentbox-{agent}-{project}
            local rest="${name#agentbox-}"
            local agent="${rest%%-*}"
            local project="${rest#*-}"

            # 简化状态显示 (只取第一个词)
            local simple_status="${status%% *}"

            printf "%-30s %-10s %-35s %-15s\n" "$project" "$agent" "$name" "$simple_status"
        done <<< "$containers"
    else
        echo "  没有 agentbox 容器"
    fi
    echo

    # 显示存储使用情况
    local agentbox_base="${HOST_HOME}/.local/share/agentbox"
    if [[ -d "$agentbox_base" ]]; then
        log_info "存储使用情况:"
        du -sh "${agentbox_base}"/* 2>/dev/null | while read -r size path; do
            echo "  $(basename "$path"): $size"
        done
    fi
}

# 删除 agentbox
remove_agentbox() {
    get_user_info

    local agent="${1:-}"
    local project_name="${2:-}"

    if [[ -z "$agent" ]]; then
        log_error "需要指定 Agent 名称"
        echo "用法: agentbox rm <agent> [project-name]"
        return 1
    fi

    project_name=$(normalize_name "${project_name:-$(pwd)}")

    local container_name
    container_name=$(generate_container_name "$agent" "$project_name")

    log_warn "Removing agentbox: $container_name"

    if "$CONTAINER_ENGINE" ps -a --format '{{.Names}}' | grep -q "^${container_name}$"; then
        "$CONTAINER_ENGINE" rm -f "$container_name" 2>/dev/null
        log_success "Container removed"
    fi

    # Ask to delete home directory
    local host_home="${HOST_HOME:-$(getent passwd "${HOST_USER:-$USER}" | cut -d: -f6)}"
    local agentbox_home="${host_home}/.local/share/agentbox/${agent}/${project_name}"
    if [[ -d "$agentbox_home" ]]; then
        read -p "Delete isolated home directory? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -rf "$agentbox_home"
            log_success "Isolated home removed"
        fi
    fi
}

# 停止 agentbox
kill_agentbox() {
    local agent="${1:-}"
    local project_name="${2:-}"

    if [[ -z "$agent" ]]; then
        log_error "需要指定 Agent 名称"
        echo "用法: agentbox kill <agent> [project-name]"
        return 1
    fi

    project_name=$(normalize_name "${project_name:-$(pwd)}")

    local container_name
    container_name=$(generate_container_name "$agent" "$project_name")

    log_info "Stopping agentbox: $container_name"

    if "$CONTAINER_ENGINE" ps --format '{{.Names}}' | grep -q "^${container_name}$"; then
        "$CONTAINER_ENGINE" stop "$container_name" 2>/dev/null
        log_success "Container stopped"
    else
        log_warn "Container is not running"
    fi
}

# 显示帮助
show_help() {
    cat << 'EOF'
AI Agent Toolbox - 多 Agent 容器管理工具

用法:
  agentbox agents                          列出可用 Agents
agentbox create <agent> [project]        创建 agentbox
agentbox enter <agent> [project]         进入 agentbox
agentbox run <agent> [project] [cmd]     运行命令
agentbox list                            列出所有 agentbox
agentbox kill <agent> [project]          停止 agentbox
agentbox rm <agent> [project]            删除 agentbox
  agentbox build <agent>                   构建 Agent 镜像
  agentbox build-all                       构建所有 Agent 镜像

Agents:
  occ             OpenCode + Claude Code (Recommended)
  opencode        OpenCode AI
  claude          Claude Code
  kilo            Kilo AI
  copilot         GitHub Copilot
  qwen            Qwen AI
  codebuddy       CodeBuddy

示例:
  # 创建 OCC agentbox（推荐）
  agentbox create occ .
  agentbox enter occ .

  # 创建 OpenCode agentbox
  agentbox create opencode .
  agentbox enter opencode .

  # 创建 Claude agentbox
  agentbox create claude myproject
  agentbox run claude myproject

  # 构建所有镜像
  agentbox build-all

配置: ~/.config/agentbox/agents.yaml

EOF
}

# 主函数
main() {
    local cmd="${1:-help}"
    shift || true
    
    # 初始化
    init_config
    CONTAINER_ENGINE=$(detect_engine)
    
    case "$cmd" in
        agents|list-agents)
            list_agents
            ;;
        create)
            create_agentbox "$@"
            ;;
        enter)
            enter_agentbox "$@"
            ;;
        run)
            run_agentbox "$@"
            ;;
        list|ls)
            list_agentboxes
            ;;
        rm|remove)
            remove_agentbox "$@"
            ;;
        kill|stop)
            kill_agentbox "$@"
            ;;
        build)
            build_agent_image "$@"
            ;;
        build-all)
            build_all_agents
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "未知命令: $cmd"
            show_help
            exit 1
            ;;
    esac
}

main "$@"

# Base Toolbox Image
# 所有 Agent Toolbox 的基础镜像，包含通用开发工具

FROM ubuntu:24.04

LABEL maintainer="agentbox"
LABEL description="Base image for AI Agent Toolboxes"

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=zh_CN.UTF-8
ENV LC_ALL=zh_CN.UTF-8

# 安装基础开发环境
RUN apt-get update && apt-get install -y \
    # 基础工具
    curl \
    wget \
    git \
    vim \
    nano \
    less \
    man \
    sudo \
    ca-certificates \
    gnupg \
    lsb-release \
    software-properties-common \
    apt-transport-https \
    \
    # 构建工具
    build-essential \
    pkg-config \
    cmake \
    make \
    gcc \
    g++ \
    \
    # 开发语言
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    nodejs \
    npm \
    golang-go \
    rustc \
    cargo \
    \
    # 常用工具
    jq \
    yq \
    fzf \
    ripgrep \
    fd-find \
    tree \
    htop \
    ncdu \
    unzip \
    zip \
    tar \
    gzip \
    \
    # 网络工具
    ssh \
    openssh-client \
    dnsutils \
    net-tools \
    iputils-ping \
    netcat-openbsd \
    socat \
    \
    # 容器工具
    uidmap \
    slirp4netns \
    fuse-overlayfs \
    \
    # 系统工具
    locales \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# 设置 locale (中文)
RUN locale-gen zh_CN.UTF-8

# 安装 Node.js 20.x
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# 删除默认的 ubuntu 用户，创建 agentboxuser 用户 (UID 1000)
RUN userdel -r ubuntu 2>/dev/null || true && \
    useradd -m -u 1000 -s /bin/bash -G sudo agentboxuser && \
    echo '%sudo ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/agentbox && \
    chmod 0440 /etc/sudoers.d/agentbox

# 创建必要的目录
RUN mkdir -p /usr/share/empty && \
    mkdir -p /etc/krb5.conf.d && \
    mkdir -p /etc/ld.so.conf.d && \
    mkdir -p /etc/pkcs11/modules && \
    mkdir -p /usr/lib/rpm/macros.d && \
    mkdir -p /etc/profile.d && \
    mkdir -p /run/host

# 清理 /home（Toolbx 兼容性要求）
RUN rm -rf /home/*

# 复制并设置 entrypoint 脚本
COPY lib/agentbox-entrypoint.sh /usr/local/bin/agentbox-entrypoint.sh
RUN chmod +x /usr/local/bin/agentbox-entrypoint.sh

# 使用 entrypoint 来初始化权限
ENTRYPOINT ["/usr/local/bin/agentbox-entrypoint.sh"]
CMD ["sleep", "infinity"]
